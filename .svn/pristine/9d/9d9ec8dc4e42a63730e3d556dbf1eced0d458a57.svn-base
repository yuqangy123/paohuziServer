local skynet = require "skynet"
require "skynet.manager"

local CMD = {}

local rooms = {}--{agent, pids={}} key=roomid


function CMD.isInRoom(pid)
	for k,v in pairs(rooms) do
		for kk,vv in pairs(v.pids) do
			if vv == pid then
				return k
			end
		end
	end
end

function CMD.roomExist(rid)
	if not rooms[rid] then
		return -1
	end
	return 0
end


function CMD.createRoom(pid, jushu, zhongzhuang, qiangzhihupai)
	if CMD.isInRoom(pid) then
		return -1
	end
	
	local roomid = datacenter.get("serial_rid", "rid")
	datacenter.set("serial_rid", "rid", roomid+1)

	local room = skynet.newservice ("roomAgent")
	skynet.call(room, "lua", "initRoom", roomid, skynet.self(), jushu, zhongzhuang, qiangzhihupai)
	
	rooms[roomid] = {agent=room, pids={}}
	
	createRobotPlayer(roomid)
	
	return 0, roomid
end


skynet.start(function()
    print("roomManager service start")
	skynet.dispatch("lua", function (session, address, cmd, ...)
        --print("roomManager.dispatch.cmd: " .. cmd)
		local f = CMD[cmd]
		if f then
			skynet.ret(skynet.pack(f(...)))
		else
			skynet.ret(skynet.pack(handler.command(cmd, address, ...)))
		end
	end)
end)
