local trans = {}


local gameCenter
local msgReceiver
local R
local MSG = {}

local function getAllPids()
	local pids = {}
	local players = gameCenter:get_players()
	for i=1, R.MAX_PLAYER_COUNT do
		pids[i] = players.player[i].pid
	end
	return pids
end
		
--0成功 1人员已满 2游戏进行中
function MSG.playerEnter(res, roomId)
	local pack = {code=res, pid="", nickname="", ip="", site="", ready="", score = "", totalScore = "", gameConfig="", roomid=0}
	
	if res == 0 then
		local players = gameCenter:get_players()
		for i=1, R.MAX_PLAYER_COUNT do
			pack.pid = pack.pid .. players.player[i].pid .. ","
			pack.nickname = pack.nickname .. players.player[i].nickName .. ","
			pack.ip = pack.ip .. players.player[i].ip .. ","
			pack.site = pack.site .. players.player[i].site .. ","
			pack.ready = pack.ready .. (players.player[i]:isReady() and "1" or "0") .. ","
			pack.score = pack.score .. players.player[i]:getScore() .. ","
			pack.totalScore = pack.totalScore .. players.player[i]:getTotalScore() .. ","
		end
			
		pack.pid = string.sub(pack.pid, 1, string.len(pack.pid)-1)
		pack.nickname = string.sub(pack.nickname, 1, string.len(pack.nickname)-1)
		pack.ip = string.sub(pack.ip, 1, string.len(pack.ip)-1)
		pack.site = string.sub(pack.site, 1, string.len(pack.site)-1)
		pack.ready = string.sub(pack.ready, 1, string.len(pack.ready)-1)
		pack.score = string.sub(pack.score, 1, string.len(pack.score)-1)
		pack.totalScore = string.sub(pack.totalScore, 1, string.len(pack.totalScore)-1)
		
		pack.gameConfig = gameCenter:getGameConfig()
		pack.roomid = roomId
	end
	
	return {pack=pack, pids=getAllPids()}
end

function MSG.playerReady(pid)
	return {pids=getAllPids(), pack={pid=pid}}
end

function MSG.playerChat(pid,faceid)
	return {pack={faceid=faceid,pid=pid}, pids=getAllPids()}
end

function MSG.startGame()
	return {pack={}, pids=getAllPids()}
end

function MSG.playerInitCards(zhuangPid, remainSystemCards, roomasterPid)
	local pack = {pids="", hand="", rule="", single="", zhuangpid=zhuangPid, remainsystemcards=remainSystemCards, roommaster=roomasterPid}
	
	local mostCards = gameCenter:get_mostCards()
	local idsDesc = ""
	for k,v in pairs(mostCards) do
		idsDesc = idsDesc .. v:msgString() .. ","
	end
	idsDesc = string.sub(idsDesc, 1, string.len(idsDesc)-1)
	pack.pids = idsDesc
	
	local players = gameCenter:get_players()
	for i=1, R.MAX_PLAYER_COUNT do
		local cards = players.player[i]:getHandCards()
		local handDesc = ""
		for k,v in pairs(cards) do
			handDesc = handDesc .. v.id .. "_"
		end
		if string.len(handDesc) > 0  then handDesc = string.sub(handDesc, 1, string.len(handDesc)-1) end
		pack.hand = pack.hand .. handDesc .. ","
	end
	if string.len(pack.hand) > 0  then pack.hand = string.sub(pack.hand, 1, string.len(pack.hand)-1) end
	
	for i=1, R.MAX_PLAYER_COUNT do
		local cards = players.player[i]:getShowRuleCards()
		local ruleDesc = ""
		for rname,rlist in pairs(cards) do
			ruleDesc = ruleDesc .. rname .. ":"
			for k,rcards in pairs(rlist) do
				for kk,c in pairs(rcards) do
					ruleDesc = ruleDesc .. c .. "_"
				end
				ruleDesc = string.sub(ruleDesc, 1, string.len(ruleDesc)-1)
				ruleDesc = ruleDesc .. "-"
			end
			ruleDesc = string.sub(ruleDesc, 1, string.len(ruleDesc)-1)
			ruleDesc = ruleDesc .. "+"
		end
		ruleDesc = string.sub(ruleDesc, 1, string.len(ruleDesc)-1)
		pack.rule = pack.rule .. ruleDesc .. ","
	end
	pack.rule = string.sub(pack.rule, 1, string.len(pack.rule)-1)
	
	for i=1, R.MAX_PLAYER_COUNT do
		local cards = players.player[i]:getShowSingleCards()
		local singleDesc = ""
		for k,v in pairs(cards) do
			singleDesc = singleDesc .. v.id .. "_"
		end
		if string.len(singleDesc) > 0  then singleDesc = string.sub(singleDesc, 1, string.len(singleDesc)-1) end
		pack.single = pack.single .. singleDesc .. ","
	end
	pack.single = string.sub(pack.single, 1, string.len(pack.single)-1)
	
	return {pack=pack, pids=getAllPids()}
end

function MSG.payCardSystem(data)
	--{pid=players.player[curPaysite].pid, card=paycard}
	local pack = {pids=getAllPids(), pack={cid=data.card, pid=data.pid}}
	return pack
end

function MSG.turnPlayer(pid)
	local pack = {pids=getAllPids(), pack={pid=pid}}
	return pack
end

function MSG.payCardPlayer(data)
	local pack = {pids=getAllPids(), pack={pid=data.pid, cid=data.card}}
	return pack
end

function MSG.ruleCardsPossible(pid, data)
	local pack = {}
	
	local rule = ""
	local cid = ""
	local ocid = ""
	for k,v in pairs(data) do
		rule = rule .. v.rule .. ","
		
		local citem = ""
		local cs = ""
		for kk,vv in pairs(v.cards) do
			for kkk,vvv in pairs(vv) do
				cs = cs .. vvv .. "_"
			end
			if string.len(cs) > 0 then cs = string.sub(cs, 1, string.len(cs)-1) end
			cs = cs .. "-"
		end
		if string.len(cs) > 0 then cs = string.sub(cs, 1, string.len(cs)-1) end
		cid = cid .. cs .. ","
		
		ocid = ocid .. v.othercard .. ","
	end
	if string.len(rule) > 0 then rule = string.sub(rule, 1, string.len(rule)-1) end
	if string.len(cid) > 0 then cid = string.sub(cid, 1, string.len(cid)-1) end
	if string.len(ocid) > 0 then ocid = string.sub(ocid, 1, string.len(ocid)-1) end
	
	pack.pid = pid
	pack.rule = rule
	pack.cid = cid
	pack.ocid = ocid
	return pack
end

--data:{pid=pid, rule=R.rule.Kan, cards=v}
function MSG.payRuleCardPlayer(data)
	local pack = {pids=getAllPids(), pack={pid=data.pid, cid="", rule=data.rule}}
	
	for k,v in pairs(data.cards) do
		pack.pack.cid = pack.pack.cid .. v .. ","
	end
	if string.len(pack.pack.cid) > 0  then pack.pack.cid = string.sub(pack.pack.cid, 1, string.len(pack.pack.cid)-1) end
	
	return pack
end

function MSG.payBill(data)
	local pack = {pids=getAllPids(), pack={}}
	
	pack.pack.yieldPid = data.yieldPid
	pack.pack.yieldScore = data.yieldScore
	local payBills = ""
	for k,v in pairs(data.payBills) do
		payBills = payBills .. v[1] .. "_" .. v[2] .. ","
	end
	if string.len(payBills) > 0 then payBills = string.sub(payBills, 1, string.len(payBills)-1) end
	pack.pack.payBills = payBills
	
	return pack
end

function MSG.hupai(pid, rule)
	local pack = {pids=getAllPids(), pack={pid=pid, rule=rule}}
	
	return pack
end

function MSG.gameFinish()
	local pack = {pids=getAllPids(), pack={}}
	return pack
end



function trans:setR(rr)
	R = rr
end

function trans:setGameCenter(gamec)
	gameCenter = gamec
end

function trans:setMsgReceiver(receiver)
	msgReceiver = receiver
end

function trans:msg(msgid, ...)
	local f = assert(MSG[msgid])
	local r = f(...)
	
	msgReceiver(msgid, r)
end

return trans
